// C:\important\quiet\n\mimita-public\mimita-public\src\world\world.cpp REAL FILE PATH DEC 17 2025
// dec 16 2025
/**
 * purpose
 * get chunks for whole world 
 * so we stop doing triangle stuff forever 
 * this file runs 1 time no more just makes chunks at sstart then we use them 
 */

#include "world.h"
#include <cmath>
#include <cstdio>

static glm::ivec3 chunkCoord(glm::vec3 p, float size)
{
    return glm::ivec3(
        floor(p.x / size),
        // i think 0 here is better?
        // bc we include all triangles above and below us
        // might make it bad later for if u have hella triangles above and below u
        0, // i think we keep 0
        floor(p.z / size)
    );
}

void World::buildFromMesh(const Mesh& mesh)
{
    for (size_t i = 0; i + 2 < mesh.verts.size(); i += 3)
    {
        Triangle t{
            mesh.verts[i+0].pos,
            mesh.verts[i+1].pos,
            mesh.verts[i+2].pos
        };

        glm::vec3 center = (t.a + t.b + t.c) / 3.0f;
        glm::ivec3 c = chunkCoord(center, chunkSize);
        chunks[c].tris.push_back(t);
    }
}

// dec 17 2025 
// this is called every single frame but we still fal thru the floor need fix 
void World::getNearbyTriangles(glm::vec3 pos, std::vector<Triangle>& out) const
{

    // debug print wtf goin on 
    glm::ivec3 base = chunkCoord(pos, chunkSize);

    static glm::ivec3 last = glm::ivec3(999999);
    if (base != last)
    {
        printf("[WORLD] Player entered chunk (%d, %d, %d)\n",
            base.x, base.y, base.z);
        last = base;
    }

    // ALWAYS CALC X Y AND Z
    // DONT SKIP Y
    // THIS IS 3D NEED TO CALC UP AND DOWN TOO 
    // optimize later 
    for (int x = -1; x <= 1; x++)
    for (int y = -1; y <= 1; y++)
    for (int z = -1; z <= 1; z++)
    {
        glm::ivec3 c = base + glm::ivec3(x, y, z);
        auto it = chunks.find(c);
        if (it != chunks.end())
        {
            out.insert(out.end(),
                it->second.tris.begin(),
                it->second.tris.end());
        }
    }

    static float worldTimer = 0.0f;
    worldTimer += 0.016f; // approx frame

    if (worldTimer >= 0.5f)
    {
        worldTimer = 0.0f;
        printf(
            "[WORLD] chunk (%d %d %d) â†’ %zu tris\n",
            base.x, base.y, base.z,
            out.size()
        );
    }

}

